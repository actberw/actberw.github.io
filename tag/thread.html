<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>记录一些工作中的笔记 - thread</title>

    <link rel="stylesheet" href="../theme/css/normalize.css" />
    <link rel="stylesheet" href="../theme/css/foundation.min.css" />
    <link rel="stylesheet" href="../theme/css/style.css" />
    <link rel="stylesheet" href="../theme/css/pygments.css" />	
    <link rel="stylesheet" type="text/css" href="../theme/css/jqcloud.css" />
    <script src="../theme/js/vendor/custom.modernizr.js"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          "HTML-CSS": {
        styles: {
          ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
            },
              tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
        });
    </script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="../theme/js/jqcloud-1.0.4.min.js"></script>
    
    <script type="text/javascript">
	var word_list = [
        {text: "gdt", weight: 0.0125, link: {href: "/tag/gdt.html"}},
        {text: "pelican", weight: 0.0125, link: {href: "/tag/pelican.html"}},
        {text: "random", weight: 0.05, link: {href: "/tag/random.html"}},
        {text: "zmap", weight: 0.0125, link: {href: "/tag/zmap.html"}},
        {text: "algorithm analysis", weight: 0.05, link: {href: "/tag/algorithm-analysis.html"}},
        {text: "unicode", weight: 0.0125, link: {href: "/tag/unicode.html"}},
        {text: "mysql", weight: 0.05, link: {href: "/tag/mysql.html"}},
        {text: "ext4", weight: 0.0125, link: {href: "/tag/ext4.html"}},
        {text: "umask", weight: 0.0125, link: {href: "/tag/umask.html"}},
        {text: "nmap", weight: 0.0125, link: {href: "/tag/nmap.html"}},
        {text: "ls", weight: 0.0125, link: {href: "/tag/ls.html"}},
        {text: "triangle", weight: 0.0125, link: {href: "/tag/triangle.html"}},
        {text: "object model", weight: 0.0125, link: {href: "/tag/object-model.html"}},
        {text: "python", weight: 0.1375, link: {href: "/tag/python.html"}},
        {text: "risc", weight: 0.0125, link: {href: "/tag/risc.html"}},
        {text: "apt", weight: 0.0125, link: {href: "/tag/apt.html"}},
        {text: "underscore", weight: 0.0125, link: {href: "/tag/underscore.html"}},
        {text: "bit", weight: 0.0125, link: {href: "/tag/bit.html"}},
        {text: "daemon", weight: 0.0125, link: {href: "/tag/daemon.html"}},
        {text: "signal", weight: 0.0125, link: {href: "/tag/signal.html"}},
        {text: "real mode", weight: 0.025, link: {href: "/tag/real-mode.html"}},
        {text: "binary search", weight: 0.0125, link: {href: "/tag/binary-search.html"}},
        {text: "ldt", weight: 0.0125, link: {href: "/tag/ldt.html"}},
        {text: "orphan", weight: 0.0125, link: {href: "/tag/orphan.html"}},
        {text: "prime number", weight: 0.0125, link: {href: "/tag/prime-number.html"}},
        {text: "xtrabackup", weight: 0.025, link: {href: "/tag/xtrabackup.html"}},
        {text: "function call", weight: 0.0125, link: {href: "/tag/function-call.html"}},
        {text: "arm", weight: 0.0125, link: {href: "/tag/arm.html"}},
        {text: "matrix", weight: 0.0125, link: {href: "/tag/matrix.html"}},
        {text: "cpu ring", weight: 0.0125, link: {href: "/tag/cpu-ring.html"}},
        {text: "metaclass", weight: 0.0125, link: {href: "/tag/metaclass.html"}},
        {text: "method", weight: 0.0125, link: {href: "/tag/method.html"}},
        {text: "assembly", weight: 0.025, link: {href: "/tag/assembly.html"}},
        {text: "stack frame", weight: 0.0125, link: {href: "/tag/stack-frame.html"}},
        {text: "zombie", weight: 0.0125, link: {href: "/tag/zombie.html"}},
        {text: "protect mode", weight: 0.0125, link: {href: "/tag/protect-mode.html"}},
        {text: "zbr", weight: 0.0125, link: {href: "/tag/zbr.html"}},
        {text: "system call", weight: 0.0125, link: {href: "/tag/system-call.html"}},
        {text: "tcp/ip", weight: 0.0125, link: {href: "/tag/tcpip.html"}},
        {text: "tls", weight: 0.0125, link: {href: "/tag/tls.html"}},
        {text: "c", weight: 0.125, link: {href: "/tag/c.html"}},
        {text: "kernel thread", weight: 0.0125, link: {href: "/tag/kernel-thread.html"}},
        {text: "thread", weight: 0.025, link: {href: "/tag/thread.html"}},
        {text: "queue", weight: 0.0125, link: {href: "/tag/queue.html"}},
        {text: "data structure", weight: 0.0375, link: {href: "/tag/data-structure.html"}},
        {text: "setuid", weight: 0.025, link: {href: "/tag/setuid.html"}},
        {text: "shuffle", weight: 0.0125, link: {href: "/tag/shuffle.html"}},
        {text: "encoding", weight: 0.0125, link: {href: "/tag/encoding.html"}},
        {text: "c/c++", weight: 0.0125, link: {href: "/tag/cc.html"}},
        {text: "float", weight: 0.0125, link: {href: "/tag/float.html"}},
        {text: "chmod", weight: 0.025, link: {href: "/tag/chmod.html"}},
        {text: "vim", weight: 0.0125, link: {href: "/tag/vim.html"}},
        {text: "sourcelist", weight: 0.0125, link: {href: "/tag/sourcelist.html"}},
        {text: "linux", weight: 0.175, link: {href: "/tag/linux.html"}},
        {text: "ring", weight: 0.0125, link: {href: "/tag/ring.html"}},
        {text: "callstack", weight: 0.0125, link: {href: "/tag/callstack.html"}},
        {text: "debian", weight: 0.0125, link: {href: "/tag/debian.html"}},
        {text: "type", weight: 0.0125, link: {href: "/tag/type.html"}},
        {text: "sort", weight: 0.0125, link: {href: "/tag/sort.html"}},
        {text: "masscan", weight: 0.0125, link: {href: "/tag/masscan.html"}},
        {text: "btrfs", weight: 0.0125, link: {href: "/tag/btrfs.html"}},
        {text: "gas", weight: 0.0125, link: {href: "/tag/gas.html"}},
        {text: "user thread", weight: 0.0125, link: {href: "/tag/user-thread.html"}},
        {text: "c3", weight: 0.0125, link: {href: "/tag/c3.html"}},
        {text: "compile", weight: 0.0125, link: {href: "/tag/compile.html"}},
        {text: "descriptor", weight: 0.0125, link: {href: "/tag/descriptor.html"}},
        {text: "hdd", weight: 0.0125, link: {href: "/tag/hdd.html"}},
        {text: "setresuid", weight: 0.0125, link: {href: "/tag/setresuid.html"}},
        {text: "str", weight: 0.025, link: {href: "/tag/str.html"}},
        {text: "cisc", weight: 0.0125, link: {href: "/tag/cisc.html"}},
        {text: "a20", weight: 0.0125, link: {href: "/tag/a20.html"}},
        {text: "shebang", weight: 0.0125, link: {href: "/tag/shebang.html"}},
        {text: "process", weight: 0.0125, link: {href: "/tag/process.html"}},
        {text: "sticky", weight: 0.0125, link: {href: "/tag/sticky.html"}},
        {text: "__init__", weight: 0.0125, link: {href: "/tag/__init__.html"}},
        {text: "latency", weight: 0.0125, link: {href: "/tag/latency.html"}},
        {text: "gcd", weight: 0.0125, link: {href: "/tag/gcd.html"}},
        {text: "utf-8", weight: 0.0125, link: {href: "/tag/utf-8.html"}},
        {text: "fs", weight: 0.0125, link: {href: "/tag/fs.html"}},
        {text: "x86", weight: 0.025, link: {href: "/tag/x86.html"}},
        {text: "quote", weight: 0.0125, link: {href: "/tag/quote.html"}},
        {text: "class", weight: 0.0125, link: {href: "/tag/class.html"}},
        {text: "mangling", weight: 0.0125, link: {href: "/tag/mangling.html"}},
        {text: "stack", weight: 0.0125, link: {href: "/tag/stack.html"}},
        {text: "getuid", weight: 0.0125, link: {href: "/tag/getuid.html"}},
        {text: "algorithm", weight: 0.275, link: {href: "/tag/algorithm.html"}},
        {text: "line join", weight: 0.0125, link: {href: "/tag/line-join.html"}},
        {text: "register", weight: 0.0125, link: {href: "/tag/register.html"}},
        {text: "mro", weight: 0.0125, link: {href: "/tag/mro.html"}},
        ];
        $(function() {
            $("#tag-cloud").jQCloud(word_list);
        });
    </script>

</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="..">记录一些工作中的笔记</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
        
        

            <article>
                <a href="../posts/misc/thread.html"><h3 class="article-title">线程(thread)</h3></a>
<h6 class="subheader" title="2014-10-28T00:00:00">Tue 28 October 2014
</h6>


<p>线程是操作系统调度的基本单位(thread is a basic unit of CPU utilization), 它被包含在进程之中, 线程提供了一种并行的方式, 可以利用多核cpu(kernel thread). 一个进程中可以并发多个线程. 同一进程中的多条线程将共享该进程中的资源，如text区, data区, 虚拟地址空间，文件描述符和信号处理, 但线程有自己的调用栈, 寄存器环境(包括pc register), 本地存储, signal mask等. 进程是操作系统分配资源的最小单元, 相对于进程线程有以下优势:</p>
<ul>
<li>创建速度快, 占用资源少</li>
<li>线程间切换比进程间更快</li>
<li>线程共享地址空间, 通讯更方便(straightforward)</li>
</ul>
<p><img alt="muiti thread process" src="/img/thread_processes.jpg" /></p>
<p>线程有两种实现: kernel thread 和user thread.</p>
<h3>kernel thread</h3>
<p>通常说的内核线程有两种含义:</p>
<ul>
<li>运行在内核态daemon线程</li>
<li>可以被内核调度的实体</li>
</ul>
<p>内核线程由内核管理创建, 调度 永远都运行在内核态，抢占式的调度, 内核线程只能之用大于PAGE_OFFSET（即3GB）的地址空间，而普通进程则可以使用整个4GB的地址空间。内核线程只能调用内核函数，而普通进程必须通过系统调用才能使用内核函数.</p>
<h3>user thread</h3>
<p>用户级线程由运行时库管理创建, 调度等, 既可以运行在用户态也可以运行在内核态(参见<a href="/posts/misc/systemcall.html">系统调用</a>), 对于操作系统是不可见的，因此无法操作系统被调度. </p>
<p>相对于内核线程切换速度更快在用户态就可以完成，不需要内核参与. user threads differ from fibers in that each user thread has its own thread context instead of sharing the thread context of a single thread. </p>
<h3>thread model</h3>
<p>常见有三种线程模型:</p>
<ul>
<li>M:1: 多个用户线程对应一个内核线程, 来自用户线程的系统调用都由这个内核线程来处理, 这样有个很大的缺点如果有个阻塞的系统调用则所有线程都被阻塞了, 也不能利用多cpu.</li>
<li>1:1: 每个用户线程对应一个内核线程, 解决了M: 1的问题, linux就是这种实现.</li>
<li>M:N: M个用户线程对应N内核线程, 参见refer[6]</li>
</ul>
<h3>linux 线程实现</h3>
<p>从Linux内核的角度而言，并不存在线程这个概念。内核对线程并没有设立特别的数据结构，而是与进程一样使用task_struct结构进行描述.</p>
<p>也就是说线程在内核中也是以一个进程而存在的，都是通过系统调用clone创建, 只不过它和同类的进程共享某些资源，例如进程地址空间，进程的信号，打开的文件等(Calling clone() with CLONE_FS, CLONE_VM, CLONE_SIGHAND, and CLONE_FILES, as all of these data structures will be shared), 我们将这类特殊的进程称之为轻量级进程(Light Weight Process). </p>
<p>pthread_create 函数在linxu上就是包装的clone. 另外POSIX标准规定在一个多线程的应用程序中，所有线程都必须具有相同的PID。从线程在内核中的实现可得知，每个线程其实都有自己的pid, 为此Linux引入了线程组的概念。在一个多线程的程序中，所有线程形成一个线程组。每一个线程通常是由主线程创建的，主线程即为调用pthread_create()的线程, 对于线程组中的线程来说，其task_struct结构中的tgid字段保存该线程组中主线程的pid，而pid字段则保存每个轻量级进程的本身的pid。对于普通的进程而言，tgid和pid是相同的。事实上，getpid()系统调用中返回的是进程的tgid而不是pid。</p>
<p>refer:
 - [0]<a href="http://blog.jobbole.com/38696/">http://blog.jobbole.com/38696/</a>
 - [1]<a href="http://www.tutorialspoint.com/operating_system/os_multi_threading.htm">http://www.tutorialspoint.com/operating_system/os_multi_threading.htm</a>
 - [2]<a href="http://edsionte.com/techblog/archives/tag/pthread">http://edsionte.com/techblog/archives/tag/pthread</a>
 - [3]<a href="http://www.evanjones.ca/software/threading.html">http://www.evanjones.ca/software/threading.html</a>
 - [4]<a href="http://www.linuxjournal.com/article/1363">http://www.linuxjournal.com/article/1363</a>
 - [5]<a href="http://stackoverflow.com/questions/1178785/relationship-between-a-kernel-and-a-user-thread">http://stackoverflow.com/questions/1178785/relationship-between-a-kernel-and-a-user-thread</a>
 - [6]<a href="http://courses.cs.vt.edu/cs5204/fall09-kafura/Presentations/Scheduler-Activations.pdf">http://courses.cs.vt.edu/cs5204/fall09-kafura/Presentations/Scheduler-Activations.pdf</a>
 - [7]<a href="http://landley.net/kdocs/ols/2002/ols2002-pages-330-337.pdf">http://landley.net/kdocs/ols/2002/ols2002-pages-330-337.pdf</a>
 - [8]<a href="http://web.cs.ucdavis.edu/~wu/ecs251/KernelScheduledEntity_FreeBSD_2000.pdf">http://web.cs.ucdavis.edu/~wu/ecs251/KernelScheduledEntity_FreeBSD_2000.pdf</a>
 - [9]<a href="https://courses.cs.washington.edu/courses/cse451/11au/section/kim_au_section4.pdf">https://courses.cs.washington.edu/courses/cse451/11au/section/kim_au_section4.pdf</a></p><p class="subheader">Category: <a href="../category/misc.html">misc</a>

    Tagged: 
    <a href="../tag/linux.html">linux </a>
    <a href="../tag/thread.html">thread </a>
    <a href="../tag/user-thread.html">user thread </a>
    <a href="../tag/kernel-thread.html">kernel thread </a>
</p>



            </article>


                <hr  class="gradient"/>


        


            <article>
                <a href="../posts/misc/tls.html"><h3 class="article-title">线程局部存储(thread local storage)</h3></a>
<h6 class="subheader" title="2014-09-22T00:00:00">Mon 22 September 2014
</h6>


<p>refer:</p>
<ul>
<li>http://www.akkadia.org/drepper/tls.pdf</li>
<li>http://stackoverflow.com/questions/6611346/amd64-fs-gs-registers-in-linux</li>
</ul><p class="subheader">Category: <a href="../category/misc.html">misc</a>

    Tagged: 
    <a href="../tag/tls.html">tls </a>
    <a href="../tag/thread.html">thread </a>
    <a href="../tag/linux.html">linux </a>
</p>



                <a class="button radius secondary small right" href="../posts/misc/tls.html">Read More</a>
                <hr  class="gradient"/>
            </article>

            <!-- /#posts-list -->
<div class="pagination-centered">
<h6 class="subheader">Page 1 of 1</h6>

<p>

</p>
</div>

    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
    <!-- <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="../archives.html">Archives</a>
            <li><a href="../tags.html">Tags</a>
    </ul> -->

        <h5 class="sidebar-title">Tags</h5>
	<div id="tag-cloud" style="with: 25%; height: 245px;"></div>

		
        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="../category/adt.html">adt</a></li>
            <li><a href="../category/algorithm.html">algorithm</a></li>
            <li><a href="../category/c.html">c</a></li>
            <li><a href="../category/complexity.html">complexity</a></li>
            <li><a href="../category/coroutine.html">coroutine</a></li>
            <li><a href="../category/interview.html">interview</a></li>
            <li><a href="../category/learn-plan.html">learn-plan</a></li>
            <li><a href="../category/misc.html">misc</a></li>
            <li><a href="../category/mysql.html">mysql</a></li>
            <li><a href="../category/python.html">python</a></li>
            <li><a href="../category/security.html">security</a></li>
            <li><a href="../category/str.html">str</a></li>
            <li><a href="../category/tcp-ip.html">tcp-ip</a></li>
            <li><a href="../category/tree.html">tree</a></li>
            <li><a href="../category/vim.html">vim</a></li>
   
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="https://github.com/actberw">github</a></li>
        </ul>
		
        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="http://weibo.com/u/1950796544">weibo</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>记录一些工作中的笔记 by actberw</p> -->
            </div>
            </div>
    </div>
</footer>